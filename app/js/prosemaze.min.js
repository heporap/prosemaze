/*! prosemaze 2014-01-19 (c) Wicker Wings, 2014-2014 http://www.wi-wi.jp/*/
jQuery(".stage p").on("selectstart",function(a){a.prepentDefault()}).on("mousedown",function(a){a.preventDefault()}),jQuery(window).on("load",function(){setTimeout(function(){scrollTo(0,0)},100)});var psMaze=angular.module("psMaze",["ngRoute","psMaze.filters","psMaze.services","psMaze.directives","psMaze.animations","psMaze.controllers"]);psMaze.config(["$routeProvider",function(a){a.when("/",{templateUrl:"partials/story.html",controller:"psMazePageCtrl"}).when("/:pageNumber",{templateUrl:"partials/story.html",controller:"psMazePageCtrl"}).otherwise({redirectTo:"/"})}]);var psMazeControllers=angular.module("psMaze.controllers",[]);psMazeControllers.controller("psMazeConfigCtrl",["$scope","$routeParams","psMazeFactory","psMazeXHR",function(a,b,c,d){c.configured=-1,a.http=d.get({pageNumber:"config",cache:""+(new Date).getTime()}),a.http.$promise.then(function(d){b.pageNumber=c.curPage=b.pageNumber||0,c.title=a.title=d.title,c.width=a.width=d.width,c.height=a.height=d.height,c.pages=Number(d.pages),c.navTitle=!!d.navTitle,c.navPage=!!c.pages,c.cache=d.cache,c.curPage=b.pageNumber,c.configured=1,c.loadPage()}),a.changePage=function(a){location.hash="#/"+a},a.apply=function(){this.$apply()}}]),psMazeControllers.controller("psMazeNavCtrl",["$scope","psMazeFactory",function(a,b){a.title=b.title,a.pages=b.pages,b.controllers.push(a),a.apply=function(){a.navTitle=b.navTitle,a.pageNumber=b.curPage;var c=b.pages;if(c){a.pages=[];for(var d=0,e=c;e>d;d++)a.pages[d]=d+1}else a.pages=[]},a.changePage=function(b){a.pageNumber=b,location.hash="#/"+b}}]),psMazeControllers.controller("psMazePageCtrl",["$scope","$routeParams","$timeout","psMazeFactory","psMazeXHR",function(a,b,c,d,e){function f(a){a.show?"number"==typeof a.show||"string"==typeof a.show?a.show=[a.show,99999]:a.show.length%2&&a.show.push(99999):a.show=[0,99999]}b.pageNumber=d.curPage=b.pageNumber||0,a.talking=!0,a.lines=[],a.imageLoaded={},a.allimageloaded=!1,a.loadPage=function(){var c=d.cache?"":""+(new Date).getTime();a.script=e.get({pageNumber:b.pageNumber,cache:c}),a.script.$promise.then(function(c){a.width=d.width,a.heiht=d.height,c.scene="scenario/scene/"+c.scene,d.next=c.next||!1,d.setLines(c.lines),d.setSelection(c.select),d.onPageChange(b.pageNumber),a.imageLoaded[c.scene]=!1;for(var e,g=0;g<c.charas.length;g++)e=c.charas[g],e.url="scenario/chara/"+e.url,e.cssShow=!1,f(e,99999),a.imageLoaded[e.url]=!1;return c.lines=["","",""],c})},1!==d.configured?d.loadPage(a):a.loadPage(),a.onloadImage=function(b){var d=!0;a.imageLoaded[b]=!0,angular.forEach(a.imageLoaded,function(a){d&&(d=a)}),d&&(a.allimageloaded=!0,a.$apply(),a.talking=!1,c(a.talk,1100))},a.sellectCommand=function(b,c){return c.stopPropagation(),a.talking?(a.skip(),!1):(a.talk()||d.jumpToPage(null,b),!1)},a.nextPage=function(b){a.sellectCommand(void 0,b)},a.lines=[],a.curLine=0,a.runTalk=function(){var b=1e3/15,d=a.lines,e=a.curLine;if(!d[e]||!d[e].length){for(var f=a.curLine+1,g=0;f<d.length;f++)if(g+=d[f].length){e=a.curLine=f;break}if(!g)return a.talking=!1,!1}e=a.curLine;var h=a.lines[e].substring(0,1);a.lines[e]=a.lines[e].substring(1),a.script.lines[e]+=h,d[e].length||(b=500),c(a.runTalk,b)},a.talk=function(){if(a.talking)return-1;var b=d.getLines(a)||d.getSelection(a);if(!b)return!1;for(var c,e,f=d.curLine,g=0,h=a.script.charas;g<h.length;g++){c=h[g].show,e=f/3-1;for(var i=0;i<c.length&&(h[g].cssShow=c[i]<=e&&e<c[i+1],!h[g].cssShow);i+=2);}for(a.talking=!0,a.curLine=0,a.script.lines=[],g=0;g<a.lines.length;a.script.lines[g++]="");return a.runTalk(),!0},a.skip=function(){for(var a=0;a<this.lines.length;a++)this.script.lines[a]+=this.lines[a],this.lines[a]="";this.talking=!1}}]),angular.module("psMaze.directives",[]).directive("appVersion",["version",function(a){return function(b,c){c.text(a)}}]).directive("onloadimage",function(){return function(a,b,c){b.bind("load error",function(){a.onloadImage(c.ngSrc)})}});var psMazeServices=angular.module("psMaze.services",["ngResource"]);psMazeServices.value("version","0.1"),psMazeServices.factory("psMazeXHR",["$resource",function(a){return a("scenario/data/:pageNumber.json",{},{query:{method:"GET",params:{stageID:"stageID",pageNumber:"pageNumber"},isArray:!0}})}]),psMazeServices.factory("psMazeFactory",function(){var a={configured:0,width:"",height:"",title:"",navTitle:!1,navPage:!1,pages:0,curPage:0,lines:[],curLine:0,dialog:[],dialogShown:!1,cache:!0,controllers:[]};return a.apply=function(){for(var a=0;a<this.controllers.length;a++)this.controllers[a].apply();return this},a.loadPage=function(a){return a?this.loadWaiting=a:this.loadWaiting&&(this.loadWaiting.loadPage(),this.loadWaiting=null),this},a.setCtrlScope=function(a){return this.controllers.push(a),this},a.setLines=function(a){return this.curLine=0,this.lines.length=a.length,this.lines=a,this},a.getLines=function(a){return this.lines.length<=this.curLine?!1:(a.lines=this.lines.slice(this.curLine,this.curLine+3),this.curLine+=3,a.dialogMode="general",!!a.lines.length)},a.restartLines=function(){this.curLine=0,this.dialogShown=!1},a.setSelection=function(a){if(!a)return this.dialog=[],void(this.dialogShown=!0);if(a.length%2===0)throw new Error('Usage: ["question", "answer", "url" [, "answer", "url"]...]');return this.dialog.length=a.length,this.dialog=a,this.next=!!a.length,this.dialogShown=!this.dialog.length,this},a.getSelection=function(a){if(this.dialogShown)return!1;this.dialogShown=!0,a.lines=this.dialog.slice(0,1);for(var b=1,c=1;b<this.dialog.length;c++,b+=2)a.lines[c]=this.dialog[b];return a.dialogMode="selection",!!a.lines.length},a.jumpToPage=function(a,b){var c="#/";if(this.dialog.length){if(b=2*(b||0),!b||this.dialog.length<=b||""===this.dialog[b])return!1;var d=this.dialog[b];isNaN(d)?window.top.location.href=d:c+=d}else{if(null!==a&&void 0!==a)return window.top.location.href=a,!1;this.next===!0?c+=this.curPage+1:this.next&&(window.top.location.href=this.next)}location.hash=c},a.onPageChange=function(a){this.curPage=+a,this.apply()},a.pageChange=function(a,b){var c=b===!0?"#/"+(1+Number(a)):b||"";location.hash=c},a}),angular.module("psMaze.filters",[]).filter("interpolate",["version",function(a){return function(b){return String(b).replace(/\%VERSION\%/gm,a)}}]).filter("toBeContinued",function(a){return function(b){return b===!0?"#/"+(1+Number(a.pageNumber)):b||""}});var psMazeAnimations=angular.module("psMaze.animations",["ngAnimate"]);psMazeAnimations.animation(".field .chara",function(){return{addClass:function(a,b){return"active"==b?function(b){b&&a.stop()}:void 0},removeClass:function(a,b){return"active"==b?function(b){b&&a.stop()}:void 0}}});